defmodule SentinelCpWeb.NodesLive.Show do
  @moduledoc """
  LiveView for viewing node details.
  """
  use SentinelCpWeb, :live_view

  alias SentinelCp.{Audit, Nodes, Orgs, Projects}

  @impl true
  def mount(%{"project_slug" => project_slug, "id" => node_id} = params, _session, socket) do
    org = resolve_org(params)

    case Projects.get_project_by_slug(project_slug) do
      nil ->
        {:ok, socket |> put_flash(:error, "Project not found") |> redirect(to: ~p"/")}

      project ->
        case Nodes.get_node(node_id) do
          nil ->
            {:ok,
             socket
             |> put_flash(:error, "Node not found")
             |> redirect(to: nodes_path(org, project))}

          %{project_id: pid} = node when pid == project.id ->
            if connected?(socket) do
              Phoenix.PubSub.subscribe(SentinelCp.PubSub, "nodes:#{project.id}:#{node.id}")
              :timer.send_interval(10_000, self(), :refresh)
            end

            heartbeats = Nodes.list_recent_heartbeats(node.id, limit: 20)
            events = Nodes.list_node_events(node.id)
            runtime_config = Nodes.get_runtime_config(node.id)

            {:ok,
             socket
             |> assign(:org, org)
             |> assign(:project, project)
             |> assign(:node, node)
             |> assign(:heartbeats, heartbeats)
             |> assign(:events, events)
             |> assign(:runtime_config, runtime_config)
             |> assign(:active_tab, "events")
             |> assign(:show_label_form, false)
             |> assign(:page_title, "#{node.name} - #{project.name}")}

          _ ->
            {:ok,
             socket
             |> put_flash(:error, "Node not found")
             |> redirect(to: nodes_path(org, project))}
        end
    end
  end

  defp resolve_org(%{"org_slug" => slug}), do: Orgs.get_org_by_slug(slug)
  defp resolve_org(_), do: nil

  defp nodes_path(%{slug: org_slug}, project),
    do: ~p"/orgs/#{org_slug}/projects/#{project.slug}/nodes"

  defp nodes_path(nil, project),
    do: ~p"/projects/#{project.slug}/nodes"

  defp bundle_path(%{slug: org_slug}, project, bundle_id),
    do: ~p"/orgs/#{org_slug}/projects/#{project.slug}/bundles/#{bundle_id}"

  defp bundle_path(nil, project, bundle_id),
    do: ~p"/projects/#{project.slug}/bundles/#{bundle_id}"

  @impl true
  def handle_info(:refresh, socket) do
    node = Nodes.get_node!(socket.assigns.node.id)
    heartbeats = Nodes.list_recent_heartbeats(node.id, limit: 20)
    events = Nodes.list_node_events(node.id)
    runtime_config = Nodes.get_runtime_config(node.id)

    {:noreply,
     assign(socket,
       node: node,
       heartbeats: heartbeats,
       events: events,
       runtime_config: runtime_config
     )}
  end

  @impl true
  def handle_info({:node_updated, node}, socket) do
    heartbeats = Nodes.list_recent_heartbeats(node.id, limit: 20)
    events = Nodes.list_node_events(node.id)
    runtime_config = Nodes.get_runtime_config(node.id)

    {:noreply,
     assign(socket,
       node: node,
       heartbeats: heartbeats,
       events: events,
       runtime_config: runtime_config
     )}
  end

  @impl true
  def handle_event("delete", _, socket) do
    case Nodes.delete_node(socket.assigns.node) do
      {:ok, _} ->
        Audit.log_user_action(socket.assigns.current_user, "delete", "node", socket.assigns.node.id,
          project_id: socket.assigns.project.id
        )

        {:noreply,
         socket
         |> put_flash(:info, "Node deleted")
         |> redirect(to: nodes_path(socket.assigns.org, socket.assigns.project))}

      {:error, _} ->
        {:noreply, put_flash(socket, :error, "Failed to delete node")}
    end
  end

  def handle_event("toggle_label_form", _, socket) do
    {:noreply, assign(socket, show_label_form: !socket.assigns.show_label_form)}
  end

  def handle_event("update_labels", %{"labels" => labels_str}, socket) do
    labels =
      labels_str
      |> String.split("\n", trim: true)
      |> Enum.reduce(%{}, fn line, acc ->
        case String.split(line, "=", parts: 2) do
          [key, value] -> Map.put(acc, String.trim(key), String.trim(value))
          _ -> acc
        end
      end)

    node = socket.assigns.node

    case Nodes.update_node_labels(node, labels) do
      {:ok, updated} ->
        Audit.log_user_action(socket.assigns.current_user, "update_labels", "node", node.id,
          project_id: socket.assigns.project.id
        )

        {:noreply,
         socket
         |> assign(node: updated, show_label_form: false)
         |> put_flash(:info, "Labels updated.")}

      {:error, _} ->
        {:noreply, put_flash(socket, :error, "Could not update labels.")}
    end
  end

  def handle_event("switch_tab", %{"tab" => tab}, socket) do
    {:noreply, assign(socket, active_tab: tab)}
  end

  @impl true
  def render(assigns) do
    ~H"""
    <div class="space-y-4">
      <.detail_header name={@node.name} resource_type="node" back_path={nodes_path(@org, @project)}>
        <:badge>
          <.status_badge status={@node.status} />
          <span :if={@node.version} class="badge badge-outline badge-sm font-mono">v{@node.version}</span>
        </:badge>
        <:subtitle>Registered {format_datetime(@node.registered_at)}</:subtitle>
        <:action>
          <button
            phx-click="delete"
            data-confirm="Are you sure you want to delete this node?"
            class="btn btn-error btn-sm"
          >
            Delete Node
          </button>
        </:action>
      </.detail_header>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <.k8s_section title="Node Information">
          <.definition_list>
            <:item label="ID"><span class="font-mono text-sm">{@node.id}</span></:item>
            <:item label="Hostname"><span class="font-mono text-sm">{@node.hostname || "-"}</span></:item>
            <:item label="IP Address"><span class="font-mono text-sm">{@node.ip || "-"}</span></:item>
            <:item label="Version"><span class="font-mono text-sm">{@node.version || "-"}</span></:item>
            <:item label="Last Seen">
              {if @node.last_seen_at, do: format_relative_time(@node.last_seen_at), else: "Never"}
            </:item>
            <:item label="Active Bundle">
              <%= if @node.active_bundle_id do %>
                <.link navigate={bundle_path(@org, @project, @node.active_bundle_id)} class="link link-primary font-mono text-sm">
                  {String.slice(@node.active_bundle_id, 0, 8)}…
                </.link>
              <% else %>
                <span class="text-base-content/50">None</span>
              <% end %>
            </:item>
            <:item label="Staged Bundle">
              <%= if @node.staged_bundle_id do %>
                <.link navigate={bundle_path(@org, @project, @node.staged_bundle_id)} class="link link-primary font-mono text-sm">
                  {String.slice(@node.staged_bundle_id, 0, 8)}…
                </.link>
              <% else %>
                <span class="text-base-content/50">None</span>
              <% end %>
            </:item>
          </.definition_list>
        </.k8s_section>

        <div class="space-y-4">
          <.k8s_section title="Labels">
            <div class="flex justify-end mb-2">
              <button class="btn btn-ghost btn-xs" phx-click="toggle_label_form">Edit Labels</button>
            </div>
            <div :if={@show_label_form} class="mb-3">
              <form phx-submit="update_labels" class="space-y-3">
                <textarea
                  name="labels"
                  rows="5"
                  class="textarea textarea-bordered textarea-sm font-mono text-sm w-full"
                >{format_labels_for_edit(@node.labels)}</textarea>
                <div class="flex gap-2">
                  <button type="submit" class="btn btn-primary btn-xs">Save</button>
                  <button type="button" class="btn btn-ghost btn-xs" phx-click="toggle_label_form">Cancel</button>
                </div>
              </form>
            </div>
            <%= if @node.labels && map_size(@node.labels) > 0 do %>
              <div class="flex flex-wrap gap-2">
                <%= for {key, value} <- @node.labels do %>
                  <span class="badge badge-outline badge-sm">{key}: {value}</span>
                <% end %>
              </div>
            <% else %>
              <p class="text-base-content/50 text-sm">No labels</p>
            <% end %>
          </.k8s_section>

          <.k8s_section title="Capabilities">
            <%= if @node.capabilities && length(@node.capabilities) > 0 do %>
              <div class="flex flex-wrap gap-2">
                <%= for cap <- @node.capabilities do %>
                  <span class="badge badge-primary badge-outline badge-sm">{cap}</span>
                <% end %>
              </div>
            <% else %>
              <p class="text-base-content/50 text-sm">No capabilities reported</p>
            <% end %>
          </.k8s_section>
        </div>
      </div>

      <%!-- Tabbed Section --%>
      <.k8s_section>
        <div class="border-b border-base-300 mb-4">
          <div class="flex -mb-px">
            <button
              phx-click="switch_tab"
              phx-value-tab="events"
              class={"px-4 py-2 text-sm font-medium border-b-2 #{if @active_tab == "events", do: "border-primary text-primary", else: "border-transparent text-base-content/50 hover:text-base-content"}"}
            >
              Events
            </button>
            <button
              phx-click="switch_tab"
              phx-value-tab="config"
              class={"px-4 py-2 text-sm font-medium border-b-2 #{if @active_tab == "config", do: "border-primary text-primary", else: "border-transparent text-base-content/50 hover:text-base-content"}"}
            >
              Runtime Config
            </button>
            <button
              phx-click="switch_tab"
              phx-value-tab="heartbeats"
              class={"px-4 py-2 text-sm font-medium border-b-2 #{if @active_tab == "heartbeats", do: "border-primary text-primary", else: "border-transparent text-base-content/50 hover:text-base-content"}"}
            >
              Heartbeats
            </button>
          </div>
        </div>

        <div :if={@active_tab == "events"}>
          <table class="table table-sm">
            <thead class="bg-base-300">
              <tr>
                <th class="text-xs uppercase">Time</th>
                <th class="text-xs uppercase">Type</th>
                <th class="text-xs uppercase">Severity</th>
                <th class="text-xs uppercase">Message</th>
              </tr>
            </thead>
            <tbody>
              <%= for event <- @events do %>
                <tr>
                  <td class="text-sm">{format_datetime(event.inserted_at)}</td>
                  <td><span class="badge badge-outline badge-sm">{event.event_type}</span></td>
                  <td><.severity_badge severity={event.severity} /></td>
                  <td class="text-sm">{event.message}</td>
                </tr>
              <% end %>
            </tbody>
          </table>
          <div :if={Enum.empty?(@events)} class="p-8 text-center text-base-content/50">
            No events recorded yet.
          </div>
        </div>

        <div :if={@active_tab == "config"}>
          <%= if @runtime_config do %>
            <div class="mb-3 flex items-center gap-4 text-sm text-base-content/50">
              <span>Last updated: {format_datetime(@runtime_config.updated_at)}</span>
              <span class="font-mono">Hash: {String.slice(@runtime_config.config_hash, 0, 12)}…</span>
            </div>
            <pre class="bg-base-300 rounded p-4 overflow-x-auto text-sm font-mono">{@runtime_config.config_kdl}</pre>
          <% else %>
            <div class="p-8 text-center text-base-content/50">
              No runtime config reported yet.
            </div>
          <% end %>
        </div>

        <div :if={@active_tab == "heartbeats"}>
          <table class="table table-sm">
            <thead class="bg-base-300">
              <tr>
                <th class="text-xs uppercase">Timestamp</th>
                <th class="text-xs uppercase">Health Status</th>
                <th class="text-xs uppercase">Active Bundle</th>
                <th class="text-xs uppercase">Staged Bundle</th>
              </tr>
            </thead>
            <tbody>
              <%= for hb <- @heartbeats do %>
                <tr>
                  <td class="text-sm">{format_datetime(hb.inserted_at)}</td>
                  <td><.health_badge health={hb.health} /></td>
                  <td class="font-mono text-sm">{hb.active_bundle_id || "-"}</td>
                  <td class="font-mono text-sm">{hb.staged_bundle_id || "-"}</td>
                </tr>
              <% end %>
            </tbody>
          </table>
          <div :if={Enum.empty?(@heartbeats)} class="p-8 text-center text-base-content/50">
            No heartbeats recorded yet.
          </div>
        </div>
      </.k8s_section>
    </div>
    """
  end

  defp status_badge(assigns) do
    {class, text} =
      case assigns.status do
        "online" -> {"badge-success", "Online"}
        "offline" -> {"badge-error", "Offline"}
        _ -> {"badge-ghost", "Unknown"}
      end

    assigns = assign(assigns, class: class, text: text)

    ~H"""
    <span class={"badge badge-sm #{@class}"}>{@text}</span>
    """
  end

  defp health_badge(assigns) do
    status = get_in(assigns.health, ["status"]) || "unknown"

    {class, text} =
      case status do
        "healthy" -> {"badge-success", "Healthy"}
        "degraded" -> {"badge-warning", "Degraded"}
        "unhealthy" -> {"badge-error", "Unhealthy"}
        _ -> {"badge-ghost", "Unknown"}
      end

    assigns = assign(assigns, class: class, text: text)

    ~H"""
    <span class={"badge badge-sm #{@class}"}>{@text}</span>
    """
  end

  defp severity_badge(assigns) do
    {class, text} =
      case assigns.severity do
        "error" -> {"badge-error", "error"}
        "warn" -> {"badge-warning", "warn"}
        "info" -> {"badge-info", "info"}
        "debug" -> {"badge-ghost", "debug"}
        _ -> {"badge-ghost", assigns.severity || "unknown"}
      end

    assigns = assign(assigns, class: class, text: text)

    ~H"""
    <span class={"badge badge-sm #{@class}"}>{@text}</span>
    """
  end

  defp format_datetime(nil), do: "-"

  defp format_datetime(datetime) do
    Calendar.strftime(datetime, "%Y-%m-%d %H:%M:%S UTC")
  end

  defp format_labels_for_edit(nil), do: ""

  defp format_labels_for_edit(labels) when labels == %{}, do: ""

  defp format_labels_for_edit(labels) do
    labels
    |> Enum.map(fn {k, v} -> "#{k}=#{v}" end)
    |> Enum.join("\n")
  end

  defp format_relative_time(datetime) do
    diff = DateTime.diff(DateTime.utc_now(), datetime, :second)

    cond do
      diff < 60 -> "#{diff}s ago"
      diff < 3600 -> "#{div(diff, 60)}m ago"
      diff < 86400 -> "#{div(diff, 3600)}h ago"
      true -> "#{div(diff, 86400)}d ago"
    end
  end
end
